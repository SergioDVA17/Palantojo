<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<link rel="icon" type="image/x-icon" href="/Logo.png">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>PalAntojo / Mi perfil</title>
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
	<link rel="stylesheet" href="Perfil.css">
</head>

<body>

	<!-- NAVBAR -->
	<nav class="navbar navbar-expand-lg navbar-custom">
		<div class="container-fluid d-flex align-items-center justify-content-between">
			<div class="d-flex align-items-center">
				<a href="/PaginaPrincipal/PaginaPrincipal.html" title="PalAntojo">
					<img src="/Logo.png" alt="Logo" class="logo">
				</a>
				<div class="d-flex align-items-center user-info">
					<a href="/Perfil/Perfil.html" title="Perfil de usuario">
						<img id="fotoNavbar" src="/Imagenes/default.png" alt="Foto de perfil"
							class="logo">
					</a>
					<span class="username" id="nombreNavbar">@nombreUsuario</span>
				</div>
			</div>

			<form id="searchForm" class="form-inline search-bar">
				<input id="searchInput" class="form-control" type="search" placeholder="Buscar..."
					aria-label="Search">
				<button class="btn btn-search" type="submit"><i class="bi bi-search"
						id="buscar"></i></button>
			</form>

			<div class="d-flex align-items-center icon-group">
				<a href="/CrearEditarPublicacion/CrearEditarPublicacion.html" class="btn-publish"
					title="Publicar receta">
					<i class="bi bi-plus-circle-fill" id="publicar"></i>
				</a>

				<a href="/InicioSesion/InicioSesion.html" class="btn-logout" title="Cerrar sesión">
					<i class="bi bi-box-arrow-right" id="logout"></i>
				</a>
			</div>
		</div>
	</nav>

	<main class="container mt-4">

		<div class="row">
			<div class="col-md-4 text-center perfil-card">
				<img id="fotoPerfil" src="/Imagenes/default.png" alt="Foto de perfil"
					class="foto-de-perfil">
				<h4 id="nombreCompleto">Nombre completo</h4>
				<p id="nombreUsuario" class="text-muted">@nombreUsuario</p>
				<p id="correoUsuario" class="text-muted">correo@ejemplo.com</p>

				<!-- SECCIÓN DE RECETA DESTACADA -->
				<div id="recetaDestacada" class="mt-4" style="display: none;">
					<h5 class="titulo-seccion">⭐ Mi receta destacada</h5>
					<div class="card shadow-sm mt-2">
						<img id="imgRecetaDestacada" src="" class="card-img-top"
							alt="Receta destacada"
							style="height: 150px; object-fit: cover;">
						<div class="card-body">
							<h6 id="tituloRecetaDestacada" class="card-title"></h6>
							<p id="descRecetaDestacada" class="card-text small text-muted">
							</p>
							<div class="d-flex justify-content-between align-items-center">
								<small class="text-muted">
									<span id="ratingRecetaDestacada"></span> ⭐
								</small>
								<a id="linkRecetaDestacada" href="#"
									class="btn btn-sm btn-outline-primary">Ver</a>
							</div>
						</div>
					</div>
				</div>

				<a href="/EditarPerfil/EditarPerfil.html" class="btn-editar">Editar perfil</a>
			</div>

			<div class="col-md-8">
				<h3 class="titulo-seccion">Mis recetas</h3>
				<hr>
				<div id="misRecetas" class="row p-3 mb-3"></div>

				<h3 class="titulo-seccion">Recetas guardadas</h3>
				<hr>
				<div id="recetasGuardadas" class="row p-3 mb-3"></div>
			</div>
		</div>
	</main>


	<footer>
		© 2025, PalAntojo
	</footer>

	<script>
		const user = JSON.parse(sessionStorage.getItem("user"));
		if (!user) {
			window.location.href = "/InicioSesion/InicioSesion.html";
		} else {

			document.getElementById("nombreNavbar").textContent = user.username ? "@" + user.username : "@nombreUsuario";
			document.getElementById("fotoNavbar").src = user.fotoPerfil || "/Imagenes/default.png";

			// Perfil principal
			document.getElementById("fotoPerfil").src = user.fotoPerfil || "/Imagenes/default.png";
			const nombreCompleto = ((user.nombres || "") + " " + (user.apellidos || "")).trim();
			document.getElementById("nombreCompleto").textContent = nombreCompleto || "Nombre completo";
			document.getElementById("nombreUsuario").textContent = user.username ? "@" + user.username : "@nombreUsuario";
			document.getElementById("correoUsuario").textContent = user.correo || "correo@ejemplo.com";
			document.title = `PalAntojo / @${user.username}`;

			// Función para cargar la receta mejor calificada
			async function cargarRecetaDestacada() {
				try {
					const res = await fetch(`/api/user/${user.id}/top-recipe`);
					const recetaDestacada = await res.json();

					const contenedor = document.getElementById('recetaDestacada');

					if (recetaDestacada) {
						contenedor.style.display = 'block';
						document.getElementById('imgRecetaDestacada').src = recetaDestacada.imagen;
						document.getElementById('tituloRecetaDestacada').textContent = recetaDestacada.titulo;
						document.getElementById('descRecetaDestacada').textContent = recetaDestacada.descripcion || 'Sin descripción';
						document.getElementById('ratingRecetaDestacada').textContent =
							recetaDestacada.promedioCalificacion ? recetaDestacada.promedioCalificacion.toFixed(1) : '0.0';
						document.getElementById('linkRecetaDestacada').href =
							`/VerDetalles/VerDetalles.html?id=${recetaDestacada.id}`;
					} else {
						contenedor.style.display = 'none';
					}
				} catch (error) {
					console.error('Error al cargar receta destacada:', error);
					document.getElementById('recetaDestacada').style.display = 'none';
				}
			}

			// Llamar a la función después de cargar el perfil
			cargarRecetaDestacada();



			function crearCardReceta(receta, mostrarAutor = false, esPropia = false) {
				const card = document.createElement("div");
				card.classList.add("col-md-5", "card-receta", "mb-3");
				card.innerHTML = `
          <img src="${receta.imagen || '../Imagenes/default.png'}" alt="${receta.titulo}">
          <div class="card-body text-center">
            <h5 class="card-title" style="font-weight: bold;">${receta.titulo}</h5>
            <p class="card-text text-muted"><small>${receta.descripcion}</small></p>
            ${mostrarAutor
						? `<small class="text-muted">Publicada por 
                    <a href="#" class="enlace-autor" data-autor="${receta.autor || 'nombreUsuario'}">
                      @${receta.autor || 'nombreUsuario'}
                    </a></small><br>`
						: ""
					}
            <hr>
            ${esPropia
						? `<div class="d-flex justify-content-center">
                    <a href="/CrearEditarPublicacion/CrearEditarPublicacion.html" class="btn-editarReceta">Editar</a>
                    <button class="btn-eliminar">Eliminar</button>
                  </div>`
						: `<a href="/VerDetalles/VerDetalles.html" class="btn-detalles">Ver más detalles</a>`
					}
          </div>
        `;
				return card;
			}

			const misRecetas = [
				{titulo: "Sopes", descripcion: "Sopes caseros acompañados de salsa", imagen: "../Imagenes/Sopes.jpg"},
				{titulo: "Tacos", descripcion: "Tacos con salsa, aguacate y cebolla morada", imagen: "../Imagenes/Tacos.jpg"}
			];

			const guardadas = [
				{titulo: "Mole con arroz", descripcion: "Mole tradicional", imagen: "../Imagenes/Mole con arroz.jpg", autor: "Juan"}
			];

			const contMis = document.getElementById("misRecetas");
			const contGuardadas = document.getElementById("recetasGuardadas");

			misRecetas.forEach(r => contMis.appendChild(crearCardReceta(r, false, true)));
			guardadas.forEach(r => contGuardadas.appendChild(crearCardReceta(r, true, false)));

			// Busqueda
			const searchForm = document.getElementById("searchForm");
			const searchInput = document.getElementById("searchInput");
			searchForm.addEventListener("submit", (e) => {
				e.preventDefault();
				const query = searchInput.value.trim();
				if (!query) return;
				window.location.href = `/PaginaPrincipal/PaginaPrincipal.html?q=${encodeURIComponent(query)}`;
			});
		}
	</script>
</body>

</html>
