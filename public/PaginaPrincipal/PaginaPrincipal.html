<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>PalAntojo</title>
	<link rel="icon" type="image/x-icon" href="/Logo.png">
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
	<link rel="stylesheet" href="PaginaPrincipal.css">
</head>

<body>

	<!-- NAVBAR -->
	<nav class="navbar navbar-expand-lg navbar-custom">
		<div class="container-fluid d-flex align-items-center justify-content-between">
			<div class="d-flex align-items-center">
				<a href="/PaginaPrincipal/PaginaPrincipal.html" title="PalAntojo">
					<img src="/Logo.png" alt="Logo" class="logo">
				</a>
				<div class="d-flex align-items-center user-info">
					<a href="/Perfil/Perfil.html" title="Perfil de usuario">
						<img id="fotoNavbar" src="/Imagenes/default.png" alt="Foto de perfil"
							class="logo">
					</a>
					<span class="username" id="nombreNavbar">@nombreUsuario</span>
				</div>
			</div>

			<form id="searchForm" class="form-inline search-bar">
				<input id="searchInput" class="form-control" type="search" placeholder="Buscar..."
					aria-label="Search">
				<button class="btn btn-search" type="submit"><i class="bi bi-search"
						id="buscar"></i></button>
			</form>

			<div class="d-flex align-items-center icon-group">
				<a href="/CrearEditarPublicacion/CrearEditarPublicacion.html" class="btn-publish"
					title="Publicar receta">
					<i class="bi bi-plus-circle-fill" id="publicar"></i>
				</a>

				<a href="/InicioSesion/InicioSesion.html" class="btn-logout" title="Cerrar sesi√≥n">
					<i class="bi bi-box-arrow-right" id="logout"></i>
				</a>
			</div>
		</div>
	</nav>

	<main class="container mt-4">

		<!-- SECCI√ìN PARA CONTENIDO PRINCIPAL (SOLO SIN B√öSQUEDA) -->
		<div id="seccionPrincipal">

			<!-- SECCI√ìN LO M√ÅS POPULAR -->
			<div class="row mb-5">
				<div class="col-12">
					<div class="seccion-titulo-principal">
						<h2 class="titulo-seccion-principal">üî• Lo M√°s Popular</h2>
						<p class="text-muted">La receta favorita de la comunidad</p>
					</div>

					<div id="loadingPopular" class="text-center my-4">
						<div class="spinner-border text-danger" role="status">
							<span class="sr-only">Cargando...</span>
						</div>
						<p class="mt-2">Buscando la receta m√°s popular...</p>
					</div>

					<div id="contenedorPopular" class="row justify-content-center"
						style="display: none;">
						<!-- La receta m√°s popular se cargar√° aqu√≠ -->
					</div>

					<div id="mensajeVacioPopular" class="alert alert-info text-center"
						style="display: none;">
						<h4>üìù A√∫n no hay recetas con comentarios</h4>
						<p>La receta m√°s popular aparecer√° aqu√≠ cuando la comunidad comience a
							comentar.
						</p>
					</div>
				</div>
			</div>

			<!-- SECCI√ìN TOP CHEFS -->
			<div class="row mb-5">
				<div class="col-12">
					<div class="seccion-titulo-principal">
						<h2 class="titulo-seccion-principal">üë®‚Äçüç≥ Top Chefs</h2>
						<p class="text-muted">Los usuarios m√°s activos de la comunidad</p>
					</div>

					<div id="loadingChefs" class="text-center my-4">
						<div class="spinner-border text-danger" role="status">
							<span class="sr-only">Cargando...</span>
						</div>
						<p class="mt-2">Buscando a los chefs m√°s activos...</p>
					</div>

					<div id="contenedorChefs" class="row" style="display: none;">
						<!-- Los top chefs se cargar√°n aqu√≠ -->
					</div>

					<div id="mensajeVacioChefs" class="alert alert-info text-center"
						style="display: none;">
						<h4>üë• A√∫n no hay chefs activos</h4>
						<p>Los chefs m√°s activos aparecer√°n aqu√≠ cuando publiquen recetas.</p>
					</div>
				</div>
			</div>

		</div>

		<!-- SECCI√ìN PARA RESULTADOS DE B√öSQUEDA (SOLO CON B√öSQUEDA) -->
		<div id="seccionBusqueda" style="display: none;">
			<h4 class="titulo" id="mainTitle">Resultados de b√∫squeda:</h4>
			<div id="mainContent" class="row justify-content-center">
				<!-- Los resultados de b√∫squeda se cargar√°n aqu√≠ -->
			</div>
		</div>

	</main>

	<hr>
	<footer>
		¬© 2025, PalAntojo
	</footer>

	<script>
		const user = JSON.parse(sessionStorage.getItem("user"));
		if (!user) {
			window.location.href = "/InicioSesion/InicioSesion.html";
		} else {
			document.getElementById("nombreNavbar").textContent = "@" + user.username;
			document.getElementById("fotoNavbar").src = user.fotoPerfil || "/Imagenes/default.png";
		}

		// ========== FUNCIONES PARA LO M√ÅS POPULAR ==========

		// Funci√≥n para cargar la receta m√°s comentada
		async function cargarRecetaMasComentada() {
			const loading = document.getElementById('loadingPopular');
			const contenedor = document.getElementById('contenedorPopular');
			const mensajeVacio = document.getElementById('mensajeVacioPopular');

			loading.style.display = 'block';
			contenedor.style.display = 'none';
			mensajeVacio.style.display = 'none';

			try {
				const res = await fetch('/api/reportes/receta-mas-comentada');

				if (!res.ok) {
					throw new Error(`Error HTTP: ${res.status}`);
				}

				const receta = await res.json();

				loading.style.display = 'none';

				if (!receta) {
					mensajeVacio.style.display = 'block';
					return;
				}

				mostrarRecetaPopular(receta);

			} catch (error) {
				console.error('Error al cargar receta m√°s comentada:', error);
				loading.style.display = 'none';
				mensajeVacio.style.display = 'block';
			}
		}

		// Funci√≥n para mostrar la receta m√°s popular
		function mostrarRecetaPopular(receta) {
			const contenedor = document.getElementById('contenedorPopular');

			contenedor.innerHTML = `
        <div class="col-md-8 col-lg-6">
          <div class="card-receta-popular">
            <div class="badge-popular">
              <i class="bi bi-fire"></i> M√ÅS POPULAR
            </div>
            <img src="${receta.imagen}" class="card-img-top" alt="${receta.titulo}">
            <div class="card-body">
              <h3 class="card-title">${receta.titulo}</h3>
              <p class="card-text">${receta.descripcion || 'Una receta incre√≠ble que ha conquistado a la comunidad.'}</p>
              
              <div class="receta-info-popular">
                <div class="autor-info-popular">
                  <img src="${receta.autor_foto}" alt="${receta.autor}" class="autor-foto-popular">
                  <div>
                    <strong>@${receta.autor}</strong>
                    <br>
                    <small class="text-muted">${receta.estado || 'Sin estado especificado'}</small>
                  </div>
                </div>
                
                <div class="stats-popular">
                  <div class="stat-popular">
                    <i class="bi bi-chat-dots-fill"></i>
                    <div>
                      <strong>${receta.total_comentarios}</strong>
                      <small>comentarios</small>
                    </div>
                  </div>
                  <div class="stat-popular">
                    <i class="bi bi-star-fill"></i>
                    <div>
                      <strong>${receta.rating_promedio.toFixed(1)}</strong>
                      <small>rating</small>
                    </div>
                  </div>
                </div>
              </div>

              <div class="text-center mt-4">
                <a href="/VerDetalles/VerDetalles.html?id=${receta.id}" class="btn btn-ver-receta-popular">
                  <i class="bi bi-eye"></i> Ver Receta Completa
                </a>
              </div>
            </div>
          </div>
        </div>
      `;

			contenedor.style.display = 'flex';
		}

		// ========== FUNCIONES PARA TOP CHEFS ==========

		// Funci√≥n para cargar top chefs
		async function cargarTopChefs() {
			const loading = document.getElementById('loadingChefs');
			const contenedor = document.getElementById('contenedorChefs');
			const mensajeVacio = document.getElementById('mensajeVacioChefs');

			loading.style.display = 'block';
			contenedor.style.display = 'none';
			mensajeVacio.style.display = 'none';

			try {
				const res = await fetch('/api/reportes/top-usuarios-recetas');

				if (!res.ok) {
					throw new Error(`Error HTTP: ${res.status}`);
				}

				const chefs = await res.json();

				loading.style.display = 'none';

				if (chefs.length === 0) {
					mensajeVacio.style.display = 'block';
					return;
				}

				mostrarTopChefs(chefs);

			} catch (error) {
				console.error('Error al cargar top chefs:', error);
				loading.style.display = 'none';
				mensajeVacio.style.display = 'block';
			}
		}

		// Funci√≥n para mostrar top chefs
		function mostrarTopChefs(chefs) {
			const contenedor = document.getElementById('contenedorChefs');
			contenedor.innerHTML = '';

			chefs.forEach((chef, index) => {
				const posicion = index + 1;
				const card = crearCardChef(chef, posicion);
				contenedor.appendChild(card);
			});

			contenedor.style.display = 'flex';
		}

		// Funci√≥n para crear card de chef
		function crearCardChef(chef, posicion) {
			const col = document.createElement('div');
			col.className = 'col-md-4 mb-4';

			// Determinar clase de posici√≥n
			let clasePosicion = 'chef-posicion';
			let tituloPosicion = '';

			if (posicion === 1) {
				clasePosicion += ' chef-oro';
				tituloPosicion = 'ü•á Chef del Mes';
			} else if (posicion === 2) {
				clasePosicion += ' chef-plata';
				tituloPosicion = 'ü•à Top Chef';
			} else if (posicion === 3) {
				clasePosicion += ' chef-bronce';
				tituloPosicion = 'ü•â Chef Destacado';
			}

			col.innerHTML = `
        <div class="card-chef">
          <div class="${clasePosicion}">
            ${tituloPosicion}
          </div>
          <div class="chef-header">
            <img src="${chef.fotoPerfil}" alt="${chef.username}" class="chef-foto">
            <div class="chef-info">
              <h4 class="chef-nombre">${chef.nombres} ${chef.apellidos}</h4>
              <p class="chef-username">@${chef.username}</p>
            </div>
          </div>
          
          <div class="chef-stats">
            <div class="chef-stat">
              <i class="bi bi-journal-text"></i>
              <div>
                <strong>${chef.total_recetas}</strong>
                <small>recetas</small>
              </div>
            </div>
            <div class="chef-stat">
              <i class="bi bi-star-fill"></i>
              <div>
                <strong>${chef.rating_promedio.toFixed(1)}</strong>
                <small>rating</small>
              </div>
            </div>
            <div class="chef-stat">
              <i class="bi bi-chat-dots"></i>
              <div>
                <strong>${chef.total_comentarios_recibidos}</strong>
                <small>comentarios</small>
              </div>
            </div>
          </div>

          <div class="text-center mt-3">
            <button class="btn btn-visitar-perfil" onclick="visitarPerfil(${chef.id})">
              <i class="bi bi-person"></i> Visitar Perfil
            </button>
          </div>
        </div>
      `;

			return col;
		}

		// Funci√≥n para visitar perfil de chef
		function visitarPerfil(userId) {
			sessionStorage.setItem("visitUserId", userId);
			window.location.href = "/PerfilUsuario/PerfilUsuario.html";
		}

		// ========== FUNCIONES DE B√öSQUEDA ==========

		const searchForm = document.getElementById('searchForm');
		const searchInput = document.getElementById('searchInput');
		const seccionPrincipal = document.getElementById('seccionPrincipal');
		const seccionBusqueda = document.getElementById('seccionBusqueda');
		const mainContent = document.getElementById('mainContent');
		const mainTitle = document.getElementById('mainTitle');

		searchForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			const query = searchInput.value.trim();
			if (!query) return;

			// OCULTAR secci√≥n principal (Lo M√°s Popular y Top Chefs)
			seccionPrincipal.style.display = 'none';

			// MOSTRAR secci√≥n de b√∫squeda
			seccionBusqueda.style.display = 'block';
			mainTitle.textContent = `Buscando usuarios que coincidan con "${query}"...`;
			mainContent.innerHTML = "";

			try {
				const res = await fetch(`/api/search/users?q=${encodeURIComponent(query)}`);
				const users = await res.json();

				if (users.length === 0) {
					mainTitle.textContent = "No se encontraron resultados";
					return;
				}

				mainTitle.textContent = `Resultados de b√∫squeda (${users.length})`;
				users.forEach(u => {
					const card = document.createElement('div');
					card.classList.add('col-md-3', 'card-user', 'text-center', 'p-3');

					const isMyProfile = user.id === u.id;
					const foto = u.fotoPerfil || "/Imagenes/default.png";

					card.innerHTML = `
            <div class="card shadow-sm">
              <img src="${foto}" class="img-fluid rounded-circle mt-3" style="width:120px;height:120px;object-fit:cover;margin:auto;">
              <div class="card-body">
                <h5 class="card-title mb-0">${u.nombres} ${u.apellidos}</h5>
                <p class="text-muted">@${u.username}</p>
                <button class="verPerfilBtn">
                  Ver perfil
                </button>
              </div>
            </div>
          `;

					const btn = card.querySelector(".verPerfilBtn");
					btn.addEventListener("click", () => {
						if (isMyProfile) {
							window.location.href = "/Perfil/Perfil.html";
						} else {
							sessionStorage.setItem("visitUserId", u.id);
							window.location.href = "/PerfilUsuario/PerfilUsuario.html";
						}
					});

					mainContent.appendChild(card);
				});

			} catch (err) {
				console.error("Error en b√∫squeda:", err);
				mainTitle.textContent = "Error en la b√∫squeda";
			}
		});

		// Funci√≥n para mostrar secci√≥n principal (sin b√∫squeda)
		function mostrarSeccionPrincipal() {
			seccionBusqueda.style.display = 'none';
			seccionPrincipal.style.display = 'block';
		}

		window.addEventListener("DOMContentLoaded", async () => {
			const params = new URLSearchParams(window.location.search);
			const q = params.get("q");

			if (q) {
				// Hay b√∫squeda activa - MOSTRAR solo b√∫squeda
				searchInput.value = q;
				seccionPrincipal.style.display = 'none';
				seccionBusqueda.style.display = 'block';
				searchForm.dispatchEvent(new Event("submit"));
			} else {
				// No hay b√∫squeda - MOSTRAR solo contenido principal
				mostrarSeccionPrincipal();
				cargarRecetaMasComentada();
				cargarTopChefs();
			}
		});

		// Permitir volver al contenido principal despu√©s de una b√∫squeda
		searchInput.addEventListener('input', function () {
			if (this.value.trim() === '') {
				// Si el campo de b√∫squeda se vac√≠a, volver a mostrar contenido principal
				mostrarSeccionPrincipal();
				cargarRecetaMasComentada();
				cargarTopChefs();
			}
		});
	</script>
</body>

</html>
