<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<link rel="icon" type="image/x-icon" href="/Logo.png">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>PalAntojo / Perfil de usuario</title>
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
	<link rel="stylesheet" href="PerfilUsuario.css">
</head>

<body>

	<!-- NAVBAR -->
	<nav class="navbar navbar-expand-lg navbar-custom">
		<div class="container-fluid d-flex align-items-center justify-content-between">
			<div class="d-flex align-items-center">
				<a href="/PaginaPrincipal/PaginaPrincipal.html" title="PalAntojo">
					<img src="/Logo.png" alt="Logo" class="logo">
				</a>
				<div class="d-flex align-items-center user-info">
					<a href="/Perfil/Perfil.html" title="Perfil de usuario">
						<img id="fotoNavbar" src="/Imagenes/default.png" alt="Foto de perfil"
							class="logo">
					</a>
					<span class="username" id="nombreNavbar">@nombreUsuario</span>
				</div>
			</div>

			<form id="searchForm" class="form-inline search-bar">
				<input id="searchInput" class="form-control" type="search" placeholder="Buscar..."
					aria-label="Search">
				<button class="btn btn-search" type="submit"><i class="bi bi-search"
						id="buscar"></i></button>
			</form>

			<div class="d-flex align-items-center icon-group">
				<a href="/CrearEditarPublicacion/CrearEditarPublicacion.html" class="btn-publish"
					title="Publicar receta">
					<i class="bi bi-plus-circle-fill" id="publicar"></i>
				</a>

				<a href="/InicioSesion/InicioSesion.html" class="btn-logout" title="Cerrar sesión">
					<i class="bi bi-box-arrow-right" id="logout"></i>
				</a>
			</div>
		</div>
	</nav>

	<main class="container mt-4">
		<div class="row">
			<!-- COLUMNA IZQUIERDA - PERFIL Y RECETA DESTACADA -->
			<div class="col-md-4">
				<!-- Tarjeta de perfil -->
				<div class="text-center perfil-card">
					<img id="fotoPerfil" src="/Imagenes/default.png" alt="Foto de perfil"
						class="foto-de-perfil">
					<h4 id="nombreCompleto">Nombre completo</h4>
					<p id="nombreUsuario" class="text-muted">@nombreUsuario</p>
					<p id="correoUsuario" class="text-muted">correo@ejemplo.com</p>

					<!-- RATING DEL USUARIO -->
					<div id="userRating" class="user-rating mt-3">
						<div class="rating-stars mb-2">
							<span id="ratingStars">★★★★★</span>
						</div>
						<div class="rating-info">
							<span id="ratingValue" class="rating-value">0.0</span>
							<small class="text-muted">
								(<span id="totalCalificaciones">0</span> calificaciones)
							</small>
						</div>
						<div class="rating-stats">
							<small class="text-muted">
								<span id="totalRecetas">0</span> recetas publicadas
							</small>
						</div>
					</div>
				</div>

			</div><!-- Receta destacada - SEPARADA del perfil-card -->
			<div id="recetaDestacada" class="receta-destacada-card mt-3" style="display: none;">
				<h5 class="titulo-seccion text-center mb-3">⭐ Receta destacada</h5>
				<div class="card shadow-sm">
					<img id="imgRecetaDestacada" src="" class="card-img-top" alt="Receta destacada">
					<div class="card-body">
						<h6 id="tituloRecetaDestacada" class="card-title"></h6>
						<p id="descRecetaDestacada" class="card-text small text-muted mb-2">
						</p>
						<div class="d-flex justify-content-between align-items-center">
							<small class="text-muted">
								<span id="ratingRecetaDestacada">0.0</span> ⭐
							</small>
							<a id="linkRecetaDestacada" href="#"
								class="btn btn-sm btn-detalles">Ver detalles</a>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- COLUMNA DERECHA - RECETAS -->
		<div class="col-md-8">
			<h3 class="titulo-seccion">Recetas</h3>
			<hr>
			<div id="recetasUsuario" class="row p-3 mb-3">

			</div>

			<h3 class="titulo-seccion">Recetas guardadas</h3>
			<hr>
			<div id="recetasGuardadas" class="row p-3 mb-3">

			</div>
		</div>
		</div>
	</main>

	<footer>
		© 2025, PalAntojo
	</footer>

	<script>
		const user = JSON.parse(sessionStorage.getItem("user"));
		const visitUserId = sessionStorage.getItem("visitUserId");

		if (!user) {
			window.location.href = "/InicioSesion/InicioSesion.html";
		}

		// Navbar
		document.getElementById("nombreNavbar").textContent = user.username ? "@" + user.username : "@nombreUsuario";
		document.getElementById("fotoNavbar").src = user.fotoPerfil || "/Imagenes/default.png";

		function crearCardReceta(receta, mostrarAutor = false) {
			const card = document.createElement('div');
			card.classList.add('col-md-5', 'card-receta', 'mb-3');
			card.innerHTML = `
        <img src="${receta.imagen || '../Imagenes/Sopes.jpg'}" alt="${receta.titulo}">
        <div class="card-body text-center">
          <h5 class="card-title" style="font-weight: bold;">${receta.titulo}</h5>
          <p class="card-text text-muted"><small>${receta.descripcion}</small></p>
          ${mostrarAutor ? `<small class="text-muted">Publicada por <span>@${receta.autor || 'usuario'}</span></small><br>` : ''}
          <hr>
          <a href="/VerDetalles/VerDetalles.html" class="btn-detalles">Ver más detalles</a>
        </div>
      `;
			return card;
		}

		async function cargarUsuario() {
			if (!visitUserId) {
				alert("No se especificó el usuario a visitar");
				window.location.href = "/PaginaPrincipal/PaginaPrincipal.html";
				return;
			}

			try {
				const res = await fetch(`/users/${visitUserId}`);
				if (!res.ok) throw new Error("Error al obtener usuario");
				const visitUser = await res.json();

				document.getElementById("fotoPerfil").src = visitUser.fotoPerfil || "/Imagenes/default.png";
				document.getElementById("nombreCompleto").textContent = ((visitUser.nombres || "") + " " + (visitUser.apellidos || "")).trim();
				document.getElementById("nombreUsuario").textContent = "@" + visitUser.username;
				document.getElementById("correoUsuario").textContent = visitUser.correo || "";
				document.title = `PalAntojo / @${visitUser.username}`;

				// CARGAR RATING DEL USUARIO
				await cargarRatingUsuario(visitUserId);

				// Recetas del usuario
				const recetas = [
					{titulo: "Sopes", descripcion: "Deliciosos sopes para reunión familiar", imagen: "../Imagenes/Sopes.jpg"},
					{titulo: "Tacos", descripcion: "Tacos al pastor para evento", imagen: "../Imagenes/Tacos.jpg"}
				];
				const contenedorRecetas = document.getElementById("recetasUsuario");
				recetas.forEach(r => contenedorRecetas.appendChild(crearCardReceta(r)));

				// Recetas guardadas 
				const recetasGuardadas = [
					{titulo: "Mole con arroz", descripcion: "Delicioso mole con arroz rojo", imagen: "../Imagenes/Mole con arroz.jpg", autor: "Luisa"}
				];
				const contenedorGuardadas = document.getElementById("recetasGuardadas");
				recetasGuardadas.forEach(r => contenedorGuardadas.appendChild(crearCardReceta(r, true)));

				await cargarRecetaDestacada(visitUserId);

			} catch (err) {
				console.error(err);
				alert("No se pudo cargar el usuario");
				window.location.href = "/PaginaPrincipal/PaginaPrincipal.html";
			}
		}
		// Función para cargar receta destacada
		async function cargarRecetaDestacada(userId) {
			try {
				const res = await fetch(`/api/user/${userId}/top-recipe`);

				if (!res.ok) {
					console.log(`Respuesta no exitosa: ${res.status}`);
					return;
				}

				const contentType = res.headers.get('content-type');
				if (!contentType || !contentType.includes('application/json')) {
					console.log(`Tipo de contenido inesperado: ${contentType}`);
					return;
				}

				const recetaDestacada = await res.json();
				console.log('Receta destacada recibida:', recetaDestacada);

				const contenedor = document.getElementById('recetaDestacada');
				if (!contenedor) return;

				// Verificar si hay una receta válida
				if (recetaDestacada && recetaDestacada.titulo) {
					contenedor.style.display = 'block';

					// Asignar valores con valores por defecto
					document.getElementById('imgRecetaDestacada').src = recetaDestacada.imagen || '/Imagenes/default.png';
					document.getElementById('tituloRecetaDestacada').textContent = recetaDestacada.titulo;
					document.getElementById('descRecetaDestacada').textContent = recetaDestacada.descripcion || 'Sin descripción disponible';

					// Manejar el rating de forma segura
					let promedio = 0;
					if (recetaDestacada.promedioCalificacion !== null &&
						recetaDestacada.promedioCalificacion !== undefined) {
						promedio = parseFloat(recetaDestacada.promedioCalificacion);
						if (isNaN(promedio)) promedio = 0;
					}
					document.getElementById('ratingRecetaDestacada').textContent = promedio.toFixed(1);

					// Manejar el link
					const recipeId = recetaDestacada.id || '';
					document.getElementById('linkRecetaDestacada').href = `/VerDetalles/VerDetalles.html?id=${recipeId}`;

				} else {
					// No hay receta destacada o es inválida
					contenedor.style.display = 'none';
					console.log('No hay receta destacada disponible para este usuario');
				}
			} catch (error) {
				console.error('Error al cargar receta destacada:', error);
				const contenedor = document.getElementById('recetaDestacada');
				if (contenedor) contenedor.style.display = 'none';
			}
		}

		cargarUsuario();

		// Buscar desde navbar
		const searchForm = document.getElementById('searchForm');
		const searchInput = document.getElementById('searchInput');
		searchForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			const query = searchInput.value.trim();
			if (!query) return;
			window.location.href = `/PaginaPrincipal/PaginaPrincipal.html?q=${encodeURIComponent(query)}`;
		});

		// Función para cargar el rating del usuario
		async function cargarRatingUsuario(userId) {
			try {
				const res = await fetch(`/api/user/${userId}/rating`);

				if (!res.ok) {
					console.log(`Error al cargar rating: ${res.status}`);
					return;
				}

				const contentType = res.headers.get('content-type');
				if (!contentType || !contentType.includes('application/json')) {
					console.log(`Tipo de contenido inesperado para rating: ${contentType}`);
					return;
				}

				const ratingData = await res.json();
				console.log('Rating del usuario:', ratingData);

				actualizarInterfazRating(ratingData);

			} catch (error) {
				console.error('Error al cargar rating del usuario:', error);
				// Mostrar valores por defecto en caso de error
				actualizarInterfazRating({
					rating_promedio: 0,
					total_recetas: 0,
					total_calificaciones: 0
				});
			}
		}

		// Función para actualizar la interfaz con el rating
		function actualizarInterfazRating(ratingData) {
			const ratingPromedio = parseFloat(ratingData.rating_promedio) || 0;
			const totalRecetas = parseInt(ratingData.total_recetas) || 0;
			const totalCalificaciones = parseInt(ratingData.total_calificaciones) || 0;

			// Actualizar valores numéricos
			document.getElementById('ratingValue').textContent = ratingPromedio.toFixed(1);
			document.getElementById('totalCalificaciones').textContent = totalCalificaciones;
			document.getElementById('totalRecetas').textContent = totalRecetas;

			// Actualizar estrellas visuales
			actualizarEstrellasVisuales(ratingPromedio);
		}

		// Función para mostrar las estrellas según el rating
		function actualizarEstrellasVisuales(rating) {
			const starsElement = document.getElementById('ratingStars');
			const fullStars = Math.floor(rating);
			const hasHalfStar = rating % 1 >= 0.5;

			let starsHTML = '';

			// Estrellas llenas
			for (let i = 0; i < fullStars && i < 5; i++) {
				starsHTML += '★';
			}

			// Media estrella
			if (hasHalfStar && fullStars < 5) {
				starsHTML += '½';
			}

			// Estrellas vacías
			const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
			for (let i = 0; i < emptyStars; i++) {
				starsHTML += '☆';
			}

			starsElement.innerHTML = starsHTML;

			// Cambiar color según el rating
			if (rating >= 4) {
				starsElement.style.color = '#28a745'; // Verde para ratings altos
			} else if (rating >= 3) {
				starsElement.style.color = '#ffc107'; // Amarillo para ratings medios
			} else if (rating > 0) {
				starsElement.style.color = '#dc3545'; // Rojo para ratings bajos
			} else {
				starsElement.style.color = '#6c757d'; // Gris para sin rating
			}
		}

	</script>
</body>

</html>
